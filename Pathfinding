local Pathfinding = {}

local PathfindingService = game:GetService("PathfindingService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local Debris = game:GetService("Debris")

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local RootPart = Character:WaitForChild("HumanoidRootPart")

local WaypointFolder = Instance.new("Folder")
WaypointFolder.Name = "PathfindingVisuals"
WaypointFolder.Parent = Workspace

getgenv().Mode = getgenv().Mode or "Both"
getgenv().AgentRadius = getgenv().AgentRadius or 2
getgenv().AgentHeight = getgenv().AgentHeight or 5
getgenv().CanJump = getgenv().CanJump or true
getgenv().CanClimb = getgenv().CanClimb or true

local CurrentPathID = 0
local CurrentTarget = nil

LocalPlayer.CharacterAdded:Connect(function(NewChar)
    Character = NewChar
    Humanoid = NewChar:WaitForChild("Humanoid")
    RootPart = NewChar:WaitForChild("HumanoidRootPart")
end)

function Pathfinding:ClearWaypoints()
    WaypointFolder:ClearAllChildren()
end

function Pathfinding:CreateVisual(Position)
    local Part = Instance.new("Part")
    Part.Shape = Enum.PartType.Ball
    Part.Material = Enum.Material.Neon
    Part.Size = Vector3.new(1.5, 1.5, 1.5)
    Part.Position = Position
    Part.Anchored = true
    Part.CanCollide = false
    Part.CanQuery = false
    Part.CanTouch = false
    Part.Color = Color3.fromRGB(255, 0, 0)
    Part.Parent = WaypointFolder
    return Part
end

function Pathfinding:GetPosition(Target)
    if typeof(Target) == "Vector3" then
        return Target
    elseif typeof(Target) == "Instance" then
        if Target:IsA("BasePart") then
            return Target.Position
        elseif Target:IsA("Model") then
            return Target:GetPivot().Position
        end
    end
    return nil
end

function Pathfinding:ForceStop()
    CurrentPathID = CurrentPathID + 1
    CurrentTarget = nil
    Humanoid:MoveTo(RootPart.Position)
    Pathfinding:ClearWaypoints()
end

function Pathfinding:WalkTo(Target)
    CurrentPathID = CurrentPathID + 1
    local MyPathID = CurrentPathID
    CurrentTarget = Target

    task.spawn(function()
        local TargetPos = Pathfinding:GetPosition(Target)
        if not TargetPos then return end

        while MyPathID == CurrentPathID do
            if not Character or not RootPart or not Humanoid then break end
            
            TargetPos = Pathfinding:GetPosition(Target)
            local Distance = (RootPart.Position - TargetPos).Magnitude

            if Distance < 3 then
                Humanoid:MoveTo(TargetPos)
                break
            end

            local Path = PathfindingService:CreatePath({
                AgentRadius = getgenv().AgentRadius,
                AgentHeight = getgenv().AgentHeight,
                AgentCanJump = getgenv().CanJump,
                AgentCanClimb = getgenv().CanClimb,
                WaypointSpacing = 4,
                Costs = {
                    Water = 20
                }
            })

            local Success, ErrorMessage = pcall(function()
                Path:ComputeAsync(RootPart.Position, TargetPos)
            end)

            if Success and Path.Status == Enum.PathStatus.Success then
                Pathfinding:ClearWaypoints()
                local Waypoints = Path:GetWaypoints()
                
                if getgenv().Mode == "Show" or getgenv().Mode == "Both" then
                    for _, Point in ipairs(Waypoints) do
                        Pathfinding:CreateVisual(Point.Position)
                    end
                end

                for i, Point in ipairs(Waypoints) do
                    if MyPathID ~= CurrentPathID then return end
                    if i == 1 then continue end

                    if Point.Action == Enum.PathWaypointAction.Jump and getgenv().CanJump then
                        Humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
                    end

                    Humanoid:MoveTo(Point.Position)

                    local MoveSuccess = Humanoid.MoveToFinished:Wait()
                    local CurrentPos = RootPart.Position
                    local WaypointDist = (CurrentPos - Point.Position).Magnitude

                    if not MoveSuccess or WaypointDist > 5 then
                        break
                    end
                end
            else
                task.wait(0.5)
            end
            
            task.wait()
        end
        
        if MyPathID == CurrentPathID then
            Pathfinding:ClearWaypoints()
        end
    end)
end

return Pathfinding
