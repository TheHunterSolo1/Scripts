local Library = {}
getgenv().ESPLibrary = Library

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local CoreGui = game:GetService("CoreGui")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

local ESPList = {}
local LoopConnection = nil
local Settings = {
	Tracers = false,
	Distance = false,
	BaseSize = 21
}

local Vector2_new = Vector2.new
local Math_floor = math.floor
local Drawing_new = Drawing and Drawing.new

local function GetRoot(obj)
	if obj:IsA("BasePart") then return obj end
	if obj:IsA("Model") then return obj.PrimaryPart or obj:FindFirstChildWhichIsA("BasePart") end
	return nil
end

local function ClearObject(part)
	local data = ESPList[part]
	if data then
		if data.Highlight then data.Highlight:Destroy() end
		if data.Gui then data.Gui:Destroy() end
		if data.Tracer then data.Tracer:Remove() end
		if data.Signal then data.Signal:Disconnect() end
		ESPList[part] = nil
	end
end

function Library:SetTracers(state)
	Settings.Tracers = state
end

function Library:ShowDistance(state)
	Settings.Distance = state
end

function Library:SetBaseSize(size)
	Settings.BaseSize = size
end

function Library:RemoveESP(part)
	ClearObject(part)
end

function Library:AddESP(part, name, color)
	if not part or ESPList[part] then return end
	
	local root = GetRoot(part)
	if not root then return end
	
	local highlight = Instance.new("Highlight")
	highlight.Name = "ESPH"
	highlight.FillColor = color
	highlight.OutlineColor = color
	highlight.FillTransparency = 0.7
	highlight.OutlineTransparency = 0.5
	highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
	highlight.Adornee = part
	highlight.Enabled = false
	highlight.Parent = part
	
	local billboard = Instance.new("BillboardGui")
	billboard.Name = "ESP"
	billboard.Adornee = root
	billboard.Size = UDim2.new(0, 200, 0, 50)
	billboard.StudsOffset = Vector3.new(0, 3, 0)
	billboard.AlwaysOnTop = true
	billboard.Enabled = false
	billboard.Parent = part
	
	local label = Instance.new("TextLabel")
	label.BackgroundTransparency = 1
	label.Size = UDim2.new(1, 0, 1, 0)
	label.TextColor3 = color
	label.TextStrokeTransparency = 0
	label.Font = Enum.Font.GothamBold
	label.TextSize = Settings.BaseSize
	label.Text = name
	label.Parent = billboard
	
	local tracer = nil
	if Drawing_new then
		tracer = Drawing_new("Line")
		tracer.Visible = false
		tracer.Color = color
		tracer.Thickness = 1
		tracer.Transparency = 1
	end
	
	local signal = part.AncestryChanged:Connect(function(_, parent)
		if not parent then Library:RemoveESP(part) end
	end)
	
	ESPList[part] = {
		Root = root,
		Highlight = highlight,
		Gui = billboard,
		Label = label,
		Tracer = tracer,
		Name = name,
		Color = color,
		Signal = signal,
		LastDist = -1,
		Visible = false
	}
end

function Library:Unload()
	if LoopConnection then LoopConnection:Disconnect() end
	for part, _ in pairs(ESPList) do ClearObject(part) end
	getgenv().ESPLibrary = nil
end

LoopConnection = RunService.RenderStepped:Connect(function()
	local myRoot = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
	if not myRoot then return end
	
	local myPos = myRoot.Position
	local viewSize = Camera.ViewportSize
	local center = Vector2_new(viewSize.X / 2, viewSize.Y)
	
	local currentFOV = Camera.FieldOfView
	local dynamicSize = Math_floor(Settings.BaseSize * (currentFOV / 70))
	dynamicSize = (dynamicSize < 10) and 10 or (dynamicSize > 40) and 40 or dynamicSize

	for part, data in pairs(ESPList) do
		if data.Root and data.Root.Parent then
			local targetPos = data.Root.Position
			local screenPos, onScreen = Camera:WorldToViewportPoint(targetPos)
			local dist = (myPos - targetPos).Magnitude
			
			if onScreen then
				if not data.Visible then
					data.Visible = true
					data.Highlight.Enabled = true
					data.Gui.Enabled = true
				end

				if data.Label.TextSize ~= dynamicSize then
					data.Label.TextSize = dynamicSize
				end
				
				local intDist = Math_floor(dist)
				if Settings.Distance then
					if data.LastDist ~= intDist then
						data.LastDist = intDist
						data.Label.Text = data.Name .. "\n[" .. intDist .. "]"
					end
				else
					if data.LastDist ~= -2 then
						data.LastDist = -2
						data.Label.Text = data.Name
					end
				end
				
				if data.Tracer then
					if Settings.Tracers then
						data.Tracer.From = center
						data.Tracer.To = Vector2_new(screenPos.X, screenPos.Y)
						if not data.Tracer.Visible then data.Tracer.Visible = true end
					else
						if data.Tracer.Visible then data.Tracer.Visible = false end
					end
				end
			else
				if data.Visible then
					data.Visible = false
					data.Highlight.Enabled = false
					data.Gui.Enabled = false
					if data.Tracer then data.Tracer.Visible = false end
				end
			end
		else
			ClearObject(part)
		end
	end
end)

return Library
