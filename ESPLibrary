local Library = {}
getgenv().ESPLibrary = Library

local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local LocalPlayer = game.Players.LocalPlayer

local Updating = true
local Attach

if LocalPlayer.Character then
 Attach = Instance.new("Attachment",LocalPlayer.Character)
Attach.Name = "CharTracer"


end
LocalPlayer.CharacterAdded:Connect(function()

task.wait(1)

 Attach = Instance.new("Attachment",LocalPlayer.Character)
Attach.Name = "CharTracer"

end)


local ESPTable = {}
local TracersTable = {}
local TracersIndepenace = {}
local ObjectsIndepenace = {}
local EnableTracers = EnableTracers or false 
local ShowDis = ShowDis or false


function Library:ShowDistance(Value)

ShowDis = Value
end
function Library:SetTracers(Value)
EnableTracers = Value
end

local function CreateTracer(Part)
local TruePart
if Part:IsA("BasePart") then
TruePart = Part
elseif Part:IsA("Model") then
TruePart = Part:FindFirstChildWhichIsA("BasePart")
end
if TruePart and Attach then

if TruePart:FindFirstChild("ESP_Tracers") then return end
local AttachPart = Instance.new("Attachment",TruePart)
AttachPart.Name = "ESP_Tracers"

local Beam = Instance.new("Beam",TruePart)
Beam.Attachment0 = Attach
Beam.Attachment1 = AttachPart
Beam.Enabled = false
Beam.Name = "ESPBeam"
Beam.Width0 = 0.05
Beam.Width1 = 0.05
Beam.FaceCamera = true
Beam.Color = ColorSequence.new(Color3.new(1, 1, 1))
table.insert(TracersTable,Beam)




end



end
function Library:RemoveESP(Part)

for i, part in pairs(ESPTable) do
if part == Part then
table.remove(ESPTable, i)
break
end
end
for _, v in ipairs(Part:GetChildren()) do
if v.Name == "ESP_System" or v.Name == "ESP_GUI"  or v.Name == "ESPBeam" or v.Name == "ESP_Tracers" then
v:Destroy()
end
end
for Trace, v in ipairs(TracersTable) do
if v == Part then
table.remove(TracersTable, Trace)
break
end
end
for _, Tracerobj in pairs(Part:GetDescendants()) do

if Tracerobj.Name == "ESPBeam" or
Tracerobj.Name == "ESP_Tracers" then
Tracerobj:Destroy()
end 
end

end


function Library:AddESP(Part,Txt,Color)
if Part:FindFirstChild("ESP_System") then return end


table.insert(ESPTable, Part)

-- CreateTracer(Part)

local Highlight = Instance.new("Highlight",Part)
Highlight.Name = "ESP_System"
Highlight.FillColor = Color
Highlight.Enabled = true 
Highlight.Adornee = Part
Highlight.FillTransparency = 0.7
Highlight.OutlineTransparency = 0.4


local BillboardGui = Instance.new("BillboardGui", Part)
BillboardGui.Name = "ESP_GUI"
BillboardGui.Size = UDim2.new(0, 1, 0, 1)
BillboardGui.MaxDistance = math.huge
BillboardGui.Enabled = true
BillboardGui.AlwaysOnTop = true



local TextLabel = Instance.new("TextLabel", BillboardGui)
TextLabel.Text = Txt
TextLabel.TextSize = 23
TextLabel.Size = UDim2.new(0, 1,0, 1)
TextLabel.Font = Enum.Font.GothamBold
TextLabel.TextColor3 = Color
TextLabel.Name = "Txt"
TextLabel.TextYAlignment = "Bottom"
TextLabel.TextStrokeTransparency = 0
TextLabel.BackgroundTransparency = 1

local UIScale2 = Instance.new("UIScale",TextLabel)
UIScale2.Scale = 1

local TextLabel2 = Instance.new("TextLabel", BillboardGui)
TextLabel2.Text = "[unknown]"
TextLabel2.TextSize = 23
TextLabel2.Size = UDim2.new(0, 1,0, 1)
TextLabel2.TextColor3 = Color3.new(1, 1, 1)
TextLabel2.Name = "DistanceMarker"
TextLabel2.BackgroundTransparency = 1
TextLabel2.Font = Enum.Font.GothamBold
TextLabel2.TextStrokeTransparency = 0
TextLabel2.TextYAlignment = "Top"
TextLabel2.Visible = ShowDis
local UIScale = Instance.new("UIScale",TextLabel2)
UIScale.Scale = 1
Part:GetPropertyChangedSignal("Parent"):Connect(function(Parent)
if not Parent then
Library:RemoveESP(Part)
end
end)

end






function Library:GenerateRandomString()
return HttpService:GenerateGUID(false)
end



function Library:Unload()

Updating = false
for _, Object in ipairs(ESPTable) do
if Object then
Object:FindFirstChild("ESP_GUI"):Destroy()
Object:FindFirstChild("ESP_System"):Destroy()

ESPTable = {}
end
for _, Tracerobj in pairs(Object:GetDescendants()) do

if Tracerobj.Name == "ESPBeam" or
Tracerobj.Name == "ESP_Tracers" then
Tracerobj:Destroy()
end 
end

end
for _, Tracer in pairs(TracersTable) do
if Tracer then
Tracer:Destroy()
TracersTable = {}
end
end

getgenv().ESPLibrary = nil


end
local Con
local Time = 0
Con = RunService.Heartbeat:Connect(function(dt)
Time = Time + dt

if Time > 0.15 then
Time = 0

if Updating == false then
Con:Disconnect()
Con = nil
end

if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then


for _, Object in ipairs(ESPTable) do
if Object and Object:FindFirstChild("ESP_GUI") and Object:FindFirstChild("ESP_GUI"):FindFirstChild("DistanceMarker") then

local GuiObj = Object:FindFirstChild("ESP_GUI")
local GuiDistance = Object:FindFirstChild("ESP_GUI").DistanceMarker
local GuiTxt = Object:FindFirstChild("ESP_GUI").Txt

GuiDistance.Visible = ShowDis

if Workspace.CurrentCamera ~= nil then



local FOV = Workspace.CurrentCamera.FieldOfView

if FOV == 120 then
GuiTxt.UIScale.Scale = 2.2
GuiDistance.UIScale.Scale = 2.2

elseif FOV == 80 then
GuiTxt.UIScale.Scale = 1.5
GuiDistance.UIScale.Scale = 1.5
elseif FOV > 80  and FOV < 90 then
GuiTxt.UIScale.Scale = 1.7
GuiDistance.UIScale.Scale = 1.7
elseif FOV == 70 then
GuiTxt.UIScale.Scale = 1
GuiDistance.UIScale.Scale = 1
end


end
--[[
for i, T in pairs(TracersTable) do
if T then
local Tracer = TracersIndepenace[i]
local Obj = ObjectsIndepenace[i]
local Data = Obj:FindFirstChild("ESP_System")
Tracer.Enabled = EnableTracers
if not Tracer:GetAttribute("ColorSetted") then
Tracer.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0,Data.FillColor),
ColorSequenceKeypoint.new(1,Data.FillColor)
}
Tracer:SetAttribute("ColorSetted",true)
end

end
end
]]





local Pos = Object:IsA("Model") and Object:GetPivot().Position or Object:IsA("BasePart") and Object.Position or Vector3.new(0, 0, 0)

local Distance = (LocalPlayer.Character.HumanoidRootPart.Position - Pos).Magnitude
GuiDistance.Text = "[" .. math.floor(Distance) .. "m]" 

end

end

end 


end

end)

 return Library