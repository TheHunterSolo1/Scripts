local Library = {}
getgenv().ESPLibrary = Library

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

local ESPList = {}
local LoopConnection = nil
local Settings = {
	Tracers = false,
	Distance = false,
	Arrows = false,
	BaseSize = 15
}

local hasDrawing = pcall(function() return Drawing.new("Line") end)

local function GetRoot(obj)
	if obj:IsA("BasePart") then
		return obj
	elseif obj:IsA("Model") then
		return obj.PrimaryPart or obj:FindFirstChildWhichIsA("BasePart")
	end
	return nil
end

local function ClearObject(part)
	if ESPList[part] then
		local data = ESPList[part]
		
		if data.Highlight then data.Highlight:Destroy() end
		if data.Gui then data.Gui:Destroy() end
		
		if data.Tracer then
			data.Tracer.Visible = false
			data.Tracer:Remove()
		end

		if data.Arrow then
			data.Arrow.Visible = false
			data.Arrow:Remove()
		end
		
		if data.Signal then
			data.Signal:Disconnect()
		end
		
		ESPList[part] = nil
	end
end

function Library:GenerateRandomString()
	local length = math.random(10, 20)
	local charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
	local result = ""
	
	for i = 1, length do
		local rand = math.random(1, #charset)
		result = result .. string.sub(charset, rand, rand)
	end
	
	return result
end

function Library:SetTracers(state)
	Settings.Tracers = state
end

function Library:ShowDistance(state)
	Settings.Distance = state
end

function Library:SetArrows(state)
	Settings.Arrows = state
end

function Library:SetBaseSize(size)
	Settings.BaseSize = size
end

function Library:RemoveESP(part)
	ClearObject(part)
end

function Library:AddESP(part, name, color)
	if not part or ESPList[part] then return end
	
	local root = GetRoot(part)
	if not root then return end
	
	local highlight = Instance.new("Highlight")
	highlight.Name = "ESPHighlight"
	highlight.FillColor = color
	highlight.OutlineColor = color
	highlight.FillTransparency = 0.7
	highlight.OutlineTransparency = 0.5
	highlight.Adornee = part
	highlight.Parent = part
	
	local billboard = Instance.new("BillboardGui")
	billboard.Name = "ESPInfo"
	billboard.Adornee = root
	billboard.Size = UDim2.new(0, 200, 0, 60) 
	billboard.StudsOffset = Vector3.new(0, 3.5, 0)
	billboard.AlwaysOnTop = true
	billboard.Parent = part
	
	local label = Instance.new("TextLabel")
	label.BackgroundTransparency = 1
	label.Size = UDim2.new(1, 0, 1, 0)
	label.TextStrokeTransparency = 0
	label.TextColor3 = color
	label.Font = Enum.Font.GothamBold
	label.TextSize = Settings.BaseSize
	label.Text = name
	label.Parent = billboard
	
	local line = nil
	local arrow = nil

	if hasDrawing then
		line = Drawing.new("Line")
		line.Visible = false
		line.Color = color
		line.Thickness = 1
		line.Transparency = 1

		arrow = Drawing.new("Triangle")
		arrow.Visible = false
		arrow.Color = color
		arrow.Filled = true
		arrow.Transparency = 1
		arrow.Thickness = 1
	end
	
	local cleanupSignal = part.AncestryChanged:Connect(function(_, parent)
		if not parent then
			Library:RemoveESP(part)
		end
	end)
	
	ESPList[part] = {
		Root = root,
		Highlight = highlight,
		Gui = billboard,
		Label = label,
		Tracer = line,
		Arrow = arrow,
		Color = color,
		Signal = cleanupSignal,
		Name = name
	}
end

function Library:Unload()
	if LoopConnection then 
		LoopConnection:Disconnect() 
	end
	
	for part, _ in pairs(ESPList) do
		ClearObject(part)
	end
	
	getgenv().ESPLibrary = nil
end

LoopConnection = RunService.RenderStepped:Connect(function()
	local myRoot = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
	if not myRoot then return end
	
	local myPos = myRoot.Position
	local viewSize = Camera.ViewportSize
	local center = Vector2.new(viewSize.X / 2, viewSize.Y / 2)
	
	local currentFOV = Camera.FieldOfView
	local dynamicSize = math.floor(Settings.BaseSize * (currentFOV / 70))
	if dynamicSize < 12 then dynamicSize = 12 end
	if dynamicSize > 40 then dynamicSize = 40 end

	for part, data in pairs(ESPList) do
		if data.Root and data.Root.Parent then
			local targetPos = data.Root.Position
			local screenPos, onScreen = Camera:WorldToViewportPoint(targetPos)
			local dist = (myPos - targetPos).Magnitude
			
			if data.Label.TextSize ~= dynamicSize then
				data.Label.TextSize = dynamicSize
			end
			
			if Settings.Distance then
				data.Label.Text = string.format("%s\n[%d]", data.Name, math.floor(dist))
			else
				data.Label.Text = data.Name
			end
			
			if data.Tracer then
				if Settings.Tracers and onScreen then
					data.Tracer.From = Vector2.new(viewSize.X / 2, viewSize.Y)
					data.Tracer.To = Vector2.new(screenPos.X, screenPos.Y)
					data.Tracer.Color = data.Color
					data.Tracer.Visible = true
				else
					data.Tracer.Visible = false
				end
			end

			if data.Arrow then
				if Settings.Arrows and not onScreen then
					local relative = Camera.CFrame:PointToObjectSpace(targetPos)
					local angle = math.atan2(relative.Y, relative.X)
					
					local radius = math.min(viewSize.X, viewSize.Y) * 0.4
					local arrowPos = center + Vector2.new(math.cos(angle) * radius, -math.sin(angle) * radius)
					
					local arrowSize = 15
					local p1 = arrowPos + Vector2.new(math.cos(angle) * arrowSize, -math.sin(angle) * arrowSize)
					local p2 = arrowPos + Vector2.new(math.cos(angle + 2.5) * (arrowSize / 2), -math.sin(angle + 2.5) * (arrowSize / 2))
					local p3 = arrowPos + Vector2.new(math.cos(angle - 2.5) * (arrowSize / 2), -math.sin(angle - 2.5) * (arrowSize / 2))

					data.Arrow.PointA = p1
					data.Arrow.PointB = p2
					data.Arrow.PointC = p3
					data.Arrow.Color = data.Color
					data.Arrow.Visible = true
				else
					data.Arrow.Visible = false
				end
			end
		else
			ClearObject(part)
		end
	end
end)

return Library
