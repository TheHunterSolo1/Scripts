local Library = {}
getgenv().ESPLibrary = Library

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

local ESPList = {}
local LoopConnection = nil
local Settings = {
	Tracers = false,
	Distance = false
}

local hasDrawing = pcall(function() return Drawing.new("Line") end)

local function GetRoot(obj)
	if obj:IsA("BasePart") then
		return obj
	elseif obj:IsA("Model") then
		return obj.PrimaryPart or obj:FindFirstChildWhichIsA("BasePart")
	end
	return nil
end

local function ClearObject(part)
	if ESPList[part] then
		local data = ESPList[part]
		
		if data.Highlight then data.Highlight:Destroy() end
		if data.Gui then data.Gui:Destroy() end
		
		if data.Tracer then
			data.Tracer.Visible = false
			data.Tracer:Remove()
		end
		
		if data.Signal then
			data.Signal:Disconnect()
		end
		
		ESPList[part] = nil
	end
end

function Library:SetTracers(state)
	Settings.Tracers = state
end

function Library:ShowDistance(state)
	Settings.Distance = state
end

function Library:RemoveESP(part)
	ClearObject(part)
end

function Library:AddESP(part, name, color)
	if not part or ESPList[part] then return end
	
	local root = GetRoot(part)
	if not root then return end
	
	local highlight = Instance.new("Highlight")
	highlight.Name = "ESPHighlight"
	highlight.FillColor = color
	highlight.OutlineColor = color
	highlight.FillTransparency = 0.7
	highlight.OutlineTransparency = 0.5
	highlight.Adornee = part
	highlight.Parent = part
	
	local billboard = Instance.new("BillboardGui")
	billboard.Name = "ESPInfo"
	billboard.Adornee = root
	billboard.Size = UDim2.new(0, 200, 0, 50)
	billboard.StudsOffset = Vector3.new(0, 2, 0)
	billboard.AlwaysOnTop = true
	billboard.Parent = part
	
	local label = Instance.new("TextLabel")
	label.BackgroundTransparency = 1
	label.Size = UDim2.new(1, 0, 1, 0)
	label.TextStrokeTransparency = 0
	label.TextColor3 = color
	label.Font = Enum.Font.GothamBold
	label.TextSize = 14
	label.Text = name
	label.Parent = billboard
	
	local line = nil
	if hasDrawing then
		line = Drawing.new("Line")
		line.Visible = false
		line.Color = color
		line.Thickness = 1
		line.Transparency = 1
	end
	
	local cleanupSignal = part.AncestryChanged:Connect(function(_, parent)
		if not parent then
			Library:RemoveESP(part)
		end
	end)
	
	ESPList[part] = {
		Root = root,
		Highlight = highlight,
		Gui = billboard,
		Label = label,
		Tracer = line,
		Color = color,
		Signal = cleanupSignal,
		Name = name
	}
end

function Library:Unload()
	if LoopConnection then 
		LoopConnection:Disconnect() 
	end
	
	for part, _ in pairs(ESPList) do
		ClearObject(part)
	end
	
	getgenv().ESPLibrary = nil
end

LoopConnection = RunService.RenderStepped:Connect(function()
	local myRoot = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
	if not myRoot then return end
	
	local myPos = myRoot.Position
	local viewSize = Camera.ViewportSize
	
	for part, data in pairs(ESPList) do
		if data.Root and data.Root.Parent then
			local targetPos = data.Root.Position
			local screenPos, onScreen = Camera:WorldToViewportPoint(targetPos)
			local dist = (myPos - targetPos).Magnitude
			
			if Settings.Distance then
				data.Label.Text = string.format("%s\n[%d]", data.Name, math.floor(dist))
			else
				data.Label.Text = data.Name
			end
			
			if data.Tracer then
				if Settings.Tracers and onScreen then
					data.Tracer.From = Vector2.new(viewSize.X / 2, viewSize.Y)
					data.Tracer.To = Vector2.new(screenPos.X, screenPos.Y)
					data.Tracer.Color = data.Color
					data.Tracer.Visible = true
				else
					data.Tracer.Visible = false
				end
			end
		else
			ClearObject(part)
		end
	end
end)

return Library
